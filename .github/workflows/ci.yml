name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-type-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Type Check
        run: npm run type-check

      - name: Run Tests (unit)
        run: npm run test

      - name: Run Tests (E2E)
        run: npm run test:e2e

  build:
    runs-on: ubuntu-latest
    needs: lint-type-test
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build:production

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: build
          path: .next/
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    env:
      GCLOUD_PROJECT: placeholder-gcloud-project
      GCLOUD_SERVICE_KEY: placeholder-gcloud-service-key
      GCLOUD_RUN_SERVICE: placeholder-gcloud-run-service
      GCLOUD_RUN_REGION: placeholder-gcloud-run-region
      SENTRY_DSN_CLIENT: placeholder-sentry-dsn-client
      SENTRY_DSN_SERVER: placeholder-sentry-dsn-server
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ env.GCLOUD_SERVICE_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCLOUD_PROJECT }}

      - name: Deploy to Google Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.GCLOUD_RUN_SERVICE }}
          image: gcr.io/${{ env.GCLOUD_PROJECT }}/quote-linker-web
          region: ${{ env.GCLOUD_RUN_REGION }}
          project_id: ${{ env.GCLOUD_PROJECT }}
        env:
          SENTRY_DSN_CLIENT: placeholder-sentry-dsn-client
          SENTRY_DSN_SERVER: placeholder-sentry-dsn-server
